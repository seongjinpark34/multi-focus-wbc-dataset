# A large multi-focus WBC dataset

This repository demonstrates the generation process of multi-focal white blood cell images provided from the paper "A large multi-focus dataset for white blood cell
classification".

## Running the script

```
python main.py --test_dir ./examples/miLab_test
```

This script will generate a new directory named `./tidy_data` that contains the cropped and concatenated images of white blood cells.

## Test input directory

Every diagnosis test from miLab:tm: generates a folder with a unique test name.
A mock directory example can be found under the `examples/miLab_test` directory in the repo.
It contains multiple images representing a stack of focal planes for a sample FoV image, along with the corresponding `analyze_result.json` file generated by miLab:tm:

Note that `analyze_result.json` is metadata deserialized from serialized data obtained from miLab:tm:.

### JSON metadata in detail

`examples/miLab_test/analyze_result.json` contains a dictionary structure as shown below.

```json
{
  "0": { //image index
    "img_name": "0001_12345_12345_001_12345.jpg", // img name
    "cell_prediction":
        { "0": // cell_index
            { "prediction": 5, // cell pre-classification index from miLab.
            "location": [1374, 621, 117, 102], //cell bounding box prediction from miLab.
            "focus": 5}, // focused image stack number that is determined by miLab.
          "1": ...
        }

  },
  "1" : ...
```

In general, approximately 200\~300 unique WBCs are obtained from each slide. For each WBC, we take 10 images at different focus intervals, providing between approximately 2000\~3000 images per slide.

The image name can be broken down in the following way:
`wbcID_xCoordinate_yCoordinate_focusIndexNumber_focusScore.jpg`
where,

- The first image containing one or more WBCs is given an ID of `0001`, and then increasing incrementally
- The X and Y coordinates represent the location on the slide
- The focusIndexNumber represents where in the focus stack the image is located. These go from `000` to `009`
- and the focusScore represents numerically how in focus the image is according to our algorithm implemented in the device.

In `cell_prediction`:
The keys indicate the index of the WBC being analysed by miLab. A single image may have multiple WBCs.
Each index contains the pre-classification predition of the type of cell provided by miLab:tm:, the location of the cell, and the index that contains the best focus for that specific cell.
Pre-classification predicition indices 0 and 1 are reserved for red blooc cells and platelets, while the remaining indices correspond to different subtypes of white blood cells.
Our code accounts for the 0 and 1 indices, however these indices were omitted in the released dataset.

## Data generation process

The above information, provided by the analyze_results.json file can be used to crop each cell in the z-stack image and concatenate them horizontally.

See the `process.py` for the details.

## Data output

By default, the script generates a directory under `./tidy_data`, which then contains slide directories and image files of white blood cells in ascending order.
`labels.csv` file contains corresponding labels `crop_index`,`test_id`,`img_num`,`cell_location`.
`labels.csv` is later used to trace back the original cells for generating the dataset.
The cropped images are organized in the same manner as in the open dataset, with labels like `0_0`, `0_1`, ..., `0_9`, where the first number represents the `cell_index` and the second represents the `focus_index`. In the created folder `./tidy_data/annotation`, the images used for annotation are saved as concatenated images.

## Sample code for best focus

After generating `./tidy_data` folder, it is possible to run `get_best_focus_example.py`, which demonstrates the best focus algorithm using Laplacian Operator in OpenCV.

```
python get_best_focus_example.py  --test_dir ./tidy_data --cell_idx 0
```

This command prints the following output:

> The best focus index for image 0 is 8, which is 0_8.jpg under the folder ./tidy_data/miLab_test.
